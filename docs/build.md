# Building Luthier
Below are the required steps to build Luthier.
## Build requirements

### Operating System
Luthier should work on any Linux-based distribution with ROCm support. At the time of writing, AMD officially 
distributes ROCm for Ubuntu, Red Hat Enterprise Linux, and SUSE Linux 
(see [ROCm Installation Options](https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/install-overview.html)). 
Any compatible Distro (e.g. Debian, Mint, Fedora, etc.) can use these packages with minimal hassle. 
Other distros like Arch might also have support either in their official repositories or community-maintained 
repositories.

Luthier currently does not support Windows; This might change as the development for this project progresses.

### Software Components
The following software components are required as external dependencies for Luthier:
1. **[AMDGPU DKMS](https://docs.amd.com/projects/install-on-linux/en/latest/how-to/native-install/ubuntu.html#register-kernel-mode-driver)** 
is the kernel-mode driver for AMD GPUs. Without this, no ROCm-based application is able to run on the system.
2. **[CMake](https://cmake.org/)** is used as the build system for Luthier. **[Ninja](https://ninja-build.org/)** 
is the preferred CMake generator for this project; But any other generator e.g. **[GNU Make](https://www.gnu.org/software/make/)**
should work. The [CMakeLists.txt](../CMakeLists.txt) file for Luthier is located at the top-level directory of the project. 
**CMake v3.21 and above** is required, since it is the earliest version that supports HIP as a first-class citizen
with built-in HIP/ROCm-specific CMake variables.
3. **[AMD Code Object Manager Library (COMGR)](https://github.com/RadeonOpenCompute/ROCm-CompilerSupport/)** is, as of
right now, used for parsing the note section of the code objects, as well as linking the object files generated by Luthier
into executables. As Luthier depends more and more directly on [LLVM](https://llvm.org/), dependence on COMGR functionality
(e.g. parsing the note section, disassembly, etc.) is reduced. However, it is unlikely that we implement the 
executable-linking of COMGR ourselves.
4. **[AMD HSA and ROCm Runtime Library (ROCr)](https://github.com/RadeonOpenCompute/ROCR-Runtime)** is required to run a 
ROCm-based application on Linux systems. Luthier uses ROCr to intercept calls to AMD's Heterogeneous Systems Architecture (HSA)
implementation (including kernel launches), loading/unloading instrumentation code, 
querying the HSA agents (GPUs) present on the system, and other core GPU functionality needed by AMD GPUs for instrumentation.
5. **[AMD Compute Language Runtimes](https://github.com/ROCm-Developer-Tools/clr)** provides the runtime for AMD's 
Heterogeneous-Compute Interface for Portability (HIP). Luthier requires the HIP runtime to load user-written device functions 
for instrumentation.
6. **[HIP Compiler Driver (HIPCC)](https://github.com/ROCm/HIPCC) for compiling Luthier device code and compiling device code
in tools. 
6. **A C/C++ compiler**, like [GNU GCC](https://gcc.gnu.org/) or [Clang](https://clang.llvm.org/) for compiling the host
portion of Luthier.

The following components are dependencies automatically downloaded and compiled by CMake:
1. **[{fmt}](https://github.com/fmtlib/fmt)** library used for string formatting and pretty printing inside Luthier.
2. **[ELFIO](https://github.com/serge1/ELFIO)** library used to parse AMD ELFs for additional information not obtained
through the ROCm runtime. 
3. **[LLVM](https://llvm.org/) is the main driving force of Luthier. As of right now, it is used to disassemble 
instructions in the loaded code objects, and generate instrumented code objects. Even though the ROCm stack is shipped with a
working version of LLVM, Luthier requires the generated tables for the instructions and registers described by the
AMDGPU target in LLVM to generate code. 
Furthermore, some functionality (error checking, note section parsing, etc.) seems to require 
Runtime type information (RTTI), which is not enabled by the stock LLVM shipped by AMD.

## Build Options

### Luthier-specific Options
- **```-DLUTHIER_BUILD_EXAMPLES```**: Builds the example tools under the [examples](../examples) folder if set to 
```ON```. It is enabled by default.
- **```-DLUTHIER_LOG_LEVEL```**: Sets the log level for Luthier. Valid options include ```ERROR``` (always enabled), 
```INFO``` (prints which internal functions are called), and ```DEBUG``` (prints useful information for debugging).

### Useful CMake Options
- **```-DCMAKE_CXX_COMPILER```** and **```-DCMAKE_C_COMPILER```** set paths to the desired C/C++ compiler.
- **```-G``` sets the generator for CMake.
- **```-DCMAKE_BUILD_TYPE```** can enable/disable build with source debug information if set to ```Debug``` or 
```RelWithDebugInfo```.

## Example Build Command

```shell
mkdir build/
cd build/
cmake -DCMAKE_CXX_COMPILER=gcc -DLUTHIER_LOG_LEVEL=DEBUG -DCMAKE_BUILD_TYPE=Debug .. 
make -j
```