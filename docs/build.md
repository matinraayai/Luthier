# 2. Building Luthier
Below are the required steps to build Luthier.
## Build requirements

### Operating System
Luthier should work on any Linux-based distribution with ROCm support. At the time of writing, AMD officially
distributes ROCm for Ubuntu, Red Hat Enterprise Linux, and SUSE Linux
(see [ROCm Installation Options](https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/install-overview.html)).
Any compatible Distro (e.g. Debian, Mint, Fedora, etc.) might require building the ROCm stack manually.
Other distros like Arch might also have support either in their official repositories or community-maintained
repositories.

Luthier currently does not support Windows; This might change as the development progresses.

### Software Components
The following software components are required as external dependencies for Luthier:
1. **[AMDGPU DKMS](https://docs.amd.com/projects/install-on-linux/en/latest/how-to/native-install/ubuntu.html#register-kernel-mode-driver)**
is the kernel-mode driver for AMD GPUs. Without this, no ROCm-based application is able to run on the system.
2. **[CMake](https://cmake.org/)** is used as the build system for Luthier. **[Ninja](https://ninja-build.org/)**
is the preferred CMake generator for this project; But any other generator e.g. **[GNU Make](https://www.gnu.org/software/make/)**
should work. The [CMakeLists.txt](../CMakeLists.txt) file for Luthier is located at the top-level directory of the project.
**CMake v3.21 and above** is required, since it is the earliest version that supports HIP as a first-class citizen
with built-in HIP/ROCm-specific CMake variables.
3. **[AMD Code Object Manager Library (COMGR)](https://github.com/ROCm/llvm-project/tree/amd-staging/amd/comgr)** is used
for linking the object files generated by Luthier into executables. As Luthier depends more and more directly
on [LLVM](https://llvm.org/), dependence on COMGR functionality is reduced.
4. **[AMD HSA and ROCm Runtime Library (ROCr)](https://github.com/ROCm/ROCR-Runtime)** is required to run AMDGPU compute
kernels on Linux systems. Luthier uses ROCr to intercept calls to AMD's Heterogeneous Systems Architecture (HSA)
implementation (including kernel launches), loading/unloading instrumentation code,
querying the HSA agents (GPUs) present on the system, and other core GPU functionality needed by AMD GPUs for instrumentation.
5. **[AMD Compute Language Runtimes](https://github.com/ROCm/clr)** provides the runtime for AMD's
Heterogeneous-Compute Interface for Portability (HIP). Luthier requires the HIP runtime to load user-written device functions
for instrumentation.
6. **[HIP Compiler Driver (HIPCC)](https://github.com/ROCm/HIPCC) for compiling Luthier device code and compiling device code
in tools.
7**A C/C++ compiler**, like [GNU GCC](https://gcc.gnu.org/) or [Clang](https://clang.llvm.org/) for compiling the host
portion of Luthier.
8**[LLVM](https://llvm.org/) is the main driving force of Luthier. As of right now, it is used to disassemble
instructions in the loaded code objects, and generate instrumented code objects. Even though the ROCm stack is shipped with a
working version of LLVM, Luthier requires the generated tables for the instructions and registers described by the
AMDGPU target in LLVM to generate code.
Furthermore, some functionality (error checking, note section parsing, etc.) seems to require
Runtime type information (RTTI), which is not enabled by the stock LLVM shipped by AMD.

## Build Options

### Luthier-specific Options
- **```-DLUTHIER_BUILD_EXAMPLES```**: Builds the example tools under the [examples](../examples) folder if set to 
```ON```. It is enabled by default.
- **```-DLUTHIER_LOG_LEVEL```**: Sets the log level for Luthier. Valid options include ```ERROR``` (always enabled), 
```INFO``` (prints which internal functions are called), and ```DEBUG``` (prints useful information for debugging).

### Useful CMake Options
- **```-DCMAKE_CXX_COMPILER```** and **```-DCMAKE_C_COMPILER```** set paths to the desired C/C++ compiler.
- **```-G``` sets the generator for CMake.
- **```-DCMAKE_BUILD_TYPE```** can enable/disable build with source debug information if set to ```Debug``` or
```RelWithDebugInfo```.

## Build Instructions
1. Clone the AMD staging fork of the llvm-project in a separate directory from Luthier:
    ```shell
    git clone https://github.com/ROCm/llvm-project/ 
    ```
   As of right now we only support the staging branch. This might change in the future.
2. Configure the LLVM CMake project:
    ```shell
    mkdir build/
    cd build
    ```
    Use the following command if building a Release version:
    ```shell
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=AMDGPU -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE
        -DLLVM_ENABLE_RTTI=ON -DLLVM_ENABLE_TOOLS=OFF -DLLVM_ENABLE_EXAMPLES=OFF ../llvm
    ```
    Use the following command if building a development/debug version:
    ```shell
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -DLLVM_TARGETS_TO_BUILD=AMDGPU -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE
        -DLLVM_ENABLE_RTTI=ON -DLLVM_ENABLE_EXPENSIVE_CHECKS=ON -DLLVM_ENABLE_ASSERTIONS=ON -DLLVM_OPTIMIZED_TABLEGEN=ON
        -DLLVM_ENABLE_TOOLS=OFF -DLLVM_ENABLE_EXAMPLES=OFF ../llvm
    ```
    You can set the `CMAKE_BUILD_TYPE` to be any type you deem necessary (e.g. `Debug` for debugging, `Release` to more 
    performant code).
    You can set the generator to be `Unix Makefiles` if preferred; `Ninja` should be faster.
    The CMake project is configured to only build necessary AMDGPU-specific components of the LLVM project.
3. Build the project using the following command:
    ```shell
    cmake --build . --target AMDGPUCommonTableGen InstCombineTableGen LLVMCore LLVMBitReader LLVMSupport \
    LLVMMC LLVMAMDGPUTargetMCA LLVMAMDGPUInfo LLVMAMDGPUCodeGen LLVMAMDGPUDesc LLVMAMDGPUInfo LLVMAMDGPUDisassembler \
    LLVMAMDGPUAsmParser
    ```
    This will only build the CMake targets necessary for Luthier in LLVM. You can also just build everything by running
    ```shell
    cmake --build .
    ```
4. Change to the Luthier directory and build Luthier, pointing it to the **absolute** build folder of LLVM:
    ```shell
   mkdir build/
   cd build/
   cmake -G Ninja -DCMAKE_PREFIX_PATH=/opt/rocm/lib/cmake -DLUTHIER_LLVM_BIN_DIR=${ABSOLUTE_PATH_TO_LLVM_PROJECT}/build/
   -DLUTHIER_LLVM_SRC_DIR=${ABSOLUTE_PATH_TO_LLVM_PROJECT} ..
   cmake --build .
   ```