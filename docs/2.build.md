# Building Luthier
Below are the required steps to build Luthier.
## Build requirements

### Operating System
Luthier should work on any Linux-based distribution with ROCm support. At the time of writing, AMD officially
distributes ROCm for Ubuntu, Red Hat Enterprise Linux, and SUSE Linux
(see [ROCm Installation Options](https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/install-overview.html)).
Any compatible Distro (e.g. Debian, Mint, Fedora, etc.) might require building the ROCm stack manually.
Other distros like Arch might also have support either in their official repositories or community-maintained
repositories.

Luthier currently does not support Windows; This might change as development progresses.

### Software Components
The following is an exhaustive list of software components are required as external dependencies for Luthier:
1. **[AMDGPU DKMS](https://docs.amd.com/projects/install-on-linux/en/latest/how-to/native-install/ubuntu.html#register-kernel-mode-driver)**
is the kernel-mode driver for AMD GPUs. Without this, no ROCm-based application is able to run on the system.
2. **[CMake](https://cmake.org/)** is used as the build system for Luthier. **[Ninja](https://ninja-build.org/)**
is the preferred CMake generator for this project; But any other generator e.g. **[GNU Make](https://www.gnu.org/software/make/)**
should work. The [CMakeLists.txt](../CMakeLists.txt) file for Luthier is located at the top-level directory of the project.
**CMake v3.21 and above** is required, since it is the earliest version that supports HIP as a language
with built-in HIP/ROCm-specific CMake variables.
3. **[AMD Code Object Manager Library (COMGR)](https://github.com/ROCm/llvm-project/tree/amd-staging/amd/comgr)** is used
for linking the object files generated by Luthier into executables.
4. **[AMD HSA and ROCm Runtime Library (ROCr)](https://github.com/ROCm/ROCR-Runtime)** is required to run AMDGPU compute
kernels on Linux systems. Luthier uses ROCr to intercept calls to AMD's Heterogeneous Systems Architecture (HSA)
implementation (including kernel launches), loading/unloading instrumentation code,
querying the HSA agents (GPUs) present on the system, and other core GPU functionality needed by AMD GPUs for instrumentation.
5. **[AMD Compute Language Runtimes](https://github.com/ROCm/clr)** provides the runtime for AMD's
Heterogeneous-Compute Interface for Portability (HIP). Luthier requires the HIP runtime to load user-written device functions
for instrumentation.
6. **[HIP Compiler Driver (HIPCC)](https://github.com/ROCm/HIPCC) for compiling Luthier device code and compiling device code
in tools.
7. **A C/C++ compiler**, like [GNU GCC](https://gcc.gnu.org/) or [Clang](https://clang.llvm.org/) for compiling the host
portion of Luthier.
8. **[LLVM](https://llvm.org/)** is the main driving force of Luthier. It is primarily used to disassemble
 instructions in the loaded code objects, convert them into a valid `llvm::Module` and `llvm::MachineModuleInfo`, 
 and generate instrumented code objects. 
 Even though the ROCm stack is shipped with a working version of LLVM, Luthier opts to use an LLVM installation 
 built from source for the following reasons:
   1. The AMDGPU tablegen records for the instructions and registers described by the AMDGPU target is available in the
   source code.
   2. The concrete interface header of target-agnostic CodeGen classes for the AMDGPU backend (e.g. 
   `llvm::SIMachineFunctionInfo`) as well as some useful utilities (e.g. getting the width of a register as well as its
   target class) is only available inside the LLVM source code and required for correct functionality of Luthier. **Note
   that Luthier only includes these header files and does not compile them from scratch; These are already shipped 
   inside AMD GPU specific LLVM libraries.
   3. Some functionality (error checking, note section parsing, string formatting, etc.) require Runtime 
   type information (RTTI), which is not enabled by the stock LLVM shipped by AMD. 
   4. As the ROCm clang compiler uses static libraries for each component, it significantly increases link time
   for Luthier during development, especially if LLVM was built with debug flags turned on.
 As of right now, Luthier gets developed against the latest LLVM upstream master branch; This is to ensure any bug fixes
 in LLVM master becomes available to Luthier right away. Hence, for now, it is required both the clang compiler used
 and the LLVM library used directly by Luthier (with RTTI set to ```ON```) to be updated to the latest upstream LLVM 
 version. See the Dockerfile under the [dockerfiles](../dockerfiles) folder for how to install the ROCm clang compiler
 from source, as well as how to build a separate LLVM project for linking directly against Luthier. Keep in mind that
 building the clang compiler from scratch also required COMGR and AMD Device libs to be built from scratch as well.
 This requirement will get more relaxed as Luthier and the LLVM features it relies on become more stable.

9. **[ROCProfiler SDK](https://github.com/rocm/rocprofiler-sdk)** is used to capture the HIP and HSA API tables and
  install callbacks. See the Dockerfile under the [dockerfiles](../dockerfiles) folder on how to install the
  latest version of ROCProfiler SDK.

**Luthier works with ROCm version 6.2+**.

## Build Options

### Luthier-specific Options
- **```-DLUTHIER_BUILD_EXAMPLES```**: Builds the example tools under the [examples](../examples) folder if set to 
```ON```. It is enabled by default.
- **```-DLUTHIER_BUILD_UNIT_TESTS```**: Builds Luthier's unit test of internal components if set to ```ON```. Disabled
by default.
- **```-DLUTHIER_BUILD_INTEGRATION_TESTS```**: Builds Luthier's integration test if set to ```ON```. Disabled 
by default.
- **```-DLUTHIER_BUILD_LATEX_DOCS```**: Builds Luthier's documentation in PDF format with Doxygen using Latex if set to 
```ON```; Disabled by default. TODO: Describe Latex dependency and procedure.
- **```-DLUTHIER_BUILD_HTML_DOCS```**: Builds Luthier's documentation in HTML format with Doxygen if set to ```ON```;
Disabled by default. TODO: Describe procedure.

### Useful CMake Options
- **```-DCMAKE_CXX_COMPILER```** and **```-DCMAKE_C_COMPILER```** set paths to the desired C/C++ compiler.
- **```-G```** sets the generator for CMake.
- **```-DCMAKE_BUILD_TYPE```** can enable/disable build with source debug information if set to ```Debug``` or
```RelWithDebugInfo```. Keep in mind that enabling this option will enable the debug flag for both host and device code,
which usually results in tons of metadata info being printed when inspecting contents of instrumentation module LLVM IR.

## Dockerfile and Dev Container
Instead of ensuring all dependencies are met and breaking your host's ROCm installation in the process, 
you can use the Luthier dev container instead; To pull it, use
```shell
docker pull containers.rc.northeastern.edu/luthier/luthier-dev:latest
```
You can also view the [Dockerfile](../dockerfiles/Dockerfile) of the dev container and build it yourself from scratch.

## Build Instructions
1. Ensure all dependencies of Luthier are met; See [Build Requirements](#build-requirements), 
   [dockerfiles](../dockerfiles), and [Docker and Dev Container](#dockerfile-and-dev-container) for more information. 
2. Build the compiler plugins project against the ROCm LLVM libraries of the HIPCC clang compiler. It is usually 
   installed under `/opt/rocm/llvm/`:
    ```shell
   cd compiler-plugins/ && mkdir build/
   cmake -DCMAKE_PREFIX_PATH=/opt/rocm/llvm/ -G Ninja .. && cmake --build .
   ```
   This compiler plugin is needed by tools to embed the optimized device LLVM bitcode of the tool inside its 
   code objects; Without it, Luthier tools will not function correctly.

3. Change to the Luthier directory and build Luthier, pointing it to the **absolute** folder of the LLVM project that was
   built from source with RTTI set to `ON`, and the **absolute** path to Luthier's "Embed Optimized Bitcode" pass (if
   building the examples as well):
    ```shell
   mkdir build/
   cd build/
   cmake -G Ninja -DCMAKE_PREFIX_PATH=/opt/rocm/lib/cmake \
   -DLUTHIER_LLVM_BIN_DIR=${ABSOLUTE_PATH_TO_LLVM_PROJECT}/build/ \
   -DLUTHIER_LLVM_SRC_DIR=${ABSOLUTE_PATH_TO_LLVM_PROJECT} \
   -DLUTHIER_BC_EMBED_PLUGIN_PATH=${ABSOLUTE_PATH_TO_COMPILER_PLUGIN_BUILD}/luthier_embed_optimized_bc_plugin.so ..
   cmake --build .
   ```