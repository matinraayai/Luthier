# Building Luthier
In this section we describe the requirements for building and running Luthier.

## Requirements

### Operating System

Luthier should build and run on any Linux-based distribution with ROCm support. At the time of writing, AMD officially
distributes ROCm for Ubuntu, Red Hat Enterprise Linux, and SUSE Linux(see
[ROCm Installation Options](https://rocm.docs.amd.com/projects/install-on-linux/en/latest/tutorial/install-overview.html)).
Other distributions like Arch might also have support either in their official repositories or community-maintained 
repositories.

Luthier currently does not support Windows; This might change as development progresses.

### Software Components

The following is an exhaustive list of software components required for building and running Luthier:

#### Non-ROCm Requirements
1. **[CMake](https://cmake.org/)** is used as the build system for Luthier. **[Ninja](https://ninja-build.org/)** is the preferred CMake generator for
   Luthier; But any other generator e.g. **[GNU Make](https://www.gnu.org/software/make/)** should also work.
   The [CMakeLists.txt](../CMakeLists.txt) file for Luthier is located at the top-level directory of the project.
   **CMake v3.21 and above** is required, since it is the earliest version that supports HIP as a language
   with built-in HIP/ROCm-specific CMake variables.
2. **A C/C++ compiler**, like [GNU GCC](https://gcc.gnu.org/) or [Clang](https://clang.llvm.org/) for compiling the host
   portion of Luthier.
3. A Python 3 interpreter, and the **[CXX Header Parser](https://github.com/robotpy/cxxheaderparser)** and
   **[PCPP](https://github.com/ned14/pcpp)** Python packages are used to generate wrappers for HSA and HIP API 
   functions by inspecting the ROCm headers Luthier is being built against.

#### ROCm Requirements
**Luthier works with ROCm version 6.2.2+**:
1. **[AMDGPU DKMS](https://docs.amd.com/projects/install-on-linux/en/latest/how-to/native-install/ubuntu.html#register-kernel-mode-driver)** is the kernel-mode driver for AMD GPUs. Without this, no ROCm-based application is able to run
   on the system.
2. **[AMD Code Object Manager Library (COMGR)](https://github.com/ROCm/llvm-project/tree/amd-staging/amd/comgr)** is used for linking the object files generated by Luthier into
   HSA executables at runtime.
3. **[AMD HSA and ROCm Runtime Library (ROCr)](https://github.com/ROCm/ROCR-Runtime)** is required to run AMDGPU compute
   kernels on Linux systems. Luthier uses ROCr to intercept calls to AMD's Heterogeneous Systems Architecture (HSA)
   implementation (including kernel launches), loading/unloading instrumentation code,
   querying the HSA agents (GPUs) present on the system, and other core GPU functionality needed by AMD GPUs for
   instrumentation.
4. **[AMD Compute Language Runtimes](https://github.com/ROCm/clr)** provides the runtime for AMD's
   Heterogeneous-Compute Interface for Portability (HIP). Luthier requires the HIP runtime to load user-written device
   functions for instrumentation, and write tool-side logic.
5. **[LLVM](https://llvm.org/)** is the main driving force of Luthier. It is used to disassemble
   instructions in the loaded code objects, convert them into a valid `llvm::Module` and `llvm::MachineModuleInfo`,
   and generate instrumented code objects at runtime.
   Even though the ROCm stack is shipped with a stable version of LLVM (version 18, at the time of writing),
   Luthier opts to use the latest ROCm LLVM (version 20, at the time of writing) from the
   [amd-staging](https://github.com/ROCm/llvm-project/tree/amd-staging) branch; This is because:
    1. Luthier depends on features that have been recently introduced to LLVM. Some include port of LLVM CodeGen to the
       new pass manager, and some bug fixes contributed to the LLVM project by the Luthier development team.
    2. ROCm LLVM does not ship with Runtime Type Information (RTTI) enabled. Luthier uses RTTI-backed features in LLVM
       for things like error checking, note section parsing, and string formating.
6. **[HIP Compiler Driver (HIPCC)](https://github.com/ROCm/HIPCC)** for compiling Luthier device code and compiling device code in tools. 
   The `hipcc` driver must also be built against the LLVM 
   [amd-staging](https://github.com/ROCm/llvm-project/tree/amd-staging) branch.
7. In addition to a suitable installation of LLVM, Luthier requires the source code of the LLVM project being used 
   to build it. This is because:
    1. The AMDGPU tablegen records for the instructions and registers described by the AMDGPU target is available in the
       source code.
    2. The concrete interface header of target-agnostic CodeGen classes for the AMDGPU backend (e.g.
       `llvm::SIMachineFunctionInfo`) as well as some useful utilities (e.g. getting the width of a register as well as
       its
       target class) is only available inside the LLVM source code and required for correct functionality of Luthier. **
       Note that Luthier only includes these header files and does not compile them from scratch; These are already
       shipped
       inside AMD GPU specific LLVM libraries. These header files will also be installed under the include folder of
       Luthier.
   Luthier does not require the LLVM source code for writing and running Luthier tools.
8. **[ROCProfiler SDK](https://github.com/rocm/rocprofiler-sdk)** is used to capture the HIP and HSA API tables and install callbacks.

## Build Options

### Luthier-specific CMake Options
- **```-DLUTHIER_TOOLING_LLVM_SRC_DIR```**: Must be set to point to the source code of the LLVM project used to build
  Luthier against.
- **```-DLUTHIER_BUILD_EXAMPLES```**: Builds the example tools under the [examples](../examples) folder if set to
  ```ON```. It is enabled by default.
- **```-DLUTHIER_BUILD_UNIT_TESTS```**: Builds Luthier's unit test of internal components if set to ```ON```. Disabled
  by default.
- **```-DLUTHIER_BUILD_INTEGRATION_TESTS```**: Builds Luthier's integration test if set to ```ON```. Disabled
  by default.
- **```-DLUTHIER_BUILD_LATEX_DOCS```**: Builds Luthier's documentation in PDF format with Doxygen using Latex if set to
  ```ON```; Disabled by default. TODO: Describe Latex dependencies and procedure.
- **```-DLUTHIER_BUILD_HTML_DOCS```**: Builds Luthier's documentation in HTML format with Doxygen if set to ```ON```;
  Disabled by default. TODO: Describe documentation build procedure.

### Useful CMake Options and Commands
Refer to [CMake docs](https://cmake.org/documentation/) for more information on each of these options.
- **```-DCMAKE_PREFIX_PATH```** is a list of `;`-separated paths that CMake will search to locate requested packages.
- **```-D{PACKAGE_NAME}_DIR```**, with `PACKAGE_NAME` replaced with the name of the package (e.g. `hip`) can force
  CMake to locate the config file of the package under the given directory.
- **```-DCMAKE_CXX_COMPILER```** and **```-DCMAKE_C_COMPILER```** set paths to the desired C/C++ compiler.
- **```-G```** sets the generator for CMake.
- **```-DCMAKE_HIP_COMPILER```** can be set to the LLVM Clang compiler used to compile `.hip` tools.
- **```-DCMAKE_BUILD_TYPE```** can enable/disable build with source debug information if set to ```Debug``` or
  ```RelWithDebugInfo```. Keep in mind that enabling this option might enable the debug flag for both host and device
  code, which usually results in tons of metadata info being printed when inspecting contents of instrumentation module 
  LLVM IR.
- **```cmake --build . -t {MY_TARGET} --v --```** allows you to see each individual step made for building the
  project, very useful for debugging the build process.

## Build Instructions
> [!NOTE]
> `/opt/luthier/` is the assumed installation prefix for Luthier and its requirements of Luthier.
>  You don't have to follow this convention.
1. Ensure all non-ROCm requirements are met; See [Build Requirements](#build-requirements).
2. Ensure that ROCm requirements are met and all required ROCm packages are installed; See 
   [Build Requirements](#build-requirements) and [ROCm Installation Instructions](https://rocm.docs.amd.com/en/latest/index.html)
3. Ensure that compiler and LLVM requirements of Luthier are met:
   1. Clone the `amd-staging` of the ROCm fork of the LLVM project:
      ```bash
      git clone --depth 1 https://github.com/ROCm/llvm-project/
      ```
   2. Configure, build, and install the LLVM project (`$LLVM_SRC_DIR` is the absolute path of the LLVM project source 
      code):
      ```bash
      mkdir $LLVM_SRC_DIR/llvm-project/build && cd $LLVM_SRC_DIR/llvm-project/build &&  \
      cmake -G Ninja -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
      -DCMAKE_INSTALL_PREFIX=/opt/luthier/llvm/  \
      -DCMAKE_BUILD_TYPE=Release \
      -DLLVM_TARGETS_TO_BUILD="AMDGPU;X86"  \
      -DLLVM_ENABLE_PROJECTS="llvm;clang;lld;compiler-rt;clang-tools-extra" \
      -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \
      -DLLVM_ENABLE_EXPENSIVE_CHECKS=OFF \
      -DLIBCXX_ENABLE_SHARED=OFF \
      -DLIBCXX_ENABLE_STATIC=ON \
      -DLIBCXX_INSTALL_LIBRARY=OFF \
      -DLIBCXX_INSTALL_HEADERS=OFF \
      -DLIBCXXABI_ENABLE_SHARED=OFF \
      -DLIBCXXABI_ENABLE_STATIC=ON \
      -DLIBCXXABI_INSTALL_STATIC_LIBRARY=OFF \
      -DLLVM_ENABLE_RTTI=ON \
      -DLLVM_OPTIMIZED_TABLEGEN=ON \
      -DCLANG_ENABLE_AMDCLANG=ON \
      -DLLVM_BUILD_TOOLS=ON \
      -DLLVM_BUILD_EXAMPLES=OFF \
      -DLLVM_INCLUDE_BENCHMARKS=OFF \
      -DLLVM_BUILD_TESTS=OFF \
      -DLLVM_INCLUDE_TESTS=OFF \
      -DCLANG_INCLUDE_TESTS=OFF \
      -DLLVM_BUILD_DOCS=OFF \
      -DLLVM_ENABLE_SPHINX=OFF \
      -DSPHINX_WARNINGS_AS_ERRORS=OFF \
      -DSPHINX_OUTPUT_MAN=OFF \
      -DLLVM_ENABLE_ASSERTIONS=OFF \
      -DLLVM_ENABLE_Z3_SOLVER=OFF \
      -DLLVM_ENABLE_ZLIB=ON \
      -DLLVM_AMDGPU_ALLOW_NPI_TARGETS=ON \
      -DCLANG_DEFAULT_PIE_ON_LINUX=0 \
      -DCLANG_DEFAULT_LINKER=lld \
      -DCLANG_DEFAULT_RTLIB=compiler-rt \
      -DCLANG_DEFAULT_UNWINDLIB=libgcc \
      -DSANITIZER_AMDGPU=OFF \
      -DPACKAGE_VENDOR="AMD" \
      -DCLANG_LINK_FLANG_LEGACY=ON \
      -DCMAKE_SKIP_BUILD_RPATH=TRUE \
      -DCMAKE_SKIP_INSTALL_RPATH=TRUE \
      -DFLANG_INCLUDE_DOCS=OFF \
      ../llvm && ninja install && rm -rf $LLVM_SRC_DIR/llvm-project/build
      ```
      The following options can also be considered when building LLVM:
      - `-DBUILD_SHARED_LIBS=ON` will build LLVM with shared libraries instead of static. This option is very useful for
        development builds of Luthier, especially when building the LLVM project with debug information.
      - `-DCMAKE_BUILD_TYPE` can be set to `Debug` or `RelWithDebInfo` to build LLVM with debug information. Building
        with `Debug` also enables the LLVM's debugging macros and logging utilities.
      Dockerfiles under the [dockerfiles](../dockerfiles) folder for more information on how to build and/or install
      these requirements.
      - `-DLLVM_ENABLE_ASSERTIONS` manually enables or disables assertion in LLVM. Enabling it in development builds 
        is recommended.
   3. Configure, build, and install the AMD device libraries under the `amd/` folder of ROCm's LLVM:
      ```bash
      cd $LLVM_SRC_DIR/llvm-project/amd/device-libs && mkdir build && cd build &&  \
      cmake -G Ninja -DCMAKE_BUILD_TYPE=Release  \
      -DCMAKE_INSTALL_PREFIX=/opt/luthier/  \
      -DCMAKE_PREFIX_PATH="/opt/luthier/" ../ && ninja install && 
      rm -rf $LLVM_SRC_DIR/llvm-project/amd/device-libs/build/
      ```
   4. Configure, build, and install the `hipcc` compiler driver, also located under the `amd/` folder of ROCm's LLVM:
      ```bash
      cd $LLVM_SRC_DIR/llvm-project/amd/hipcc/ && mkdir build && cd build &&  \
      cmake -G Ninja -DCMAKE_INSTALL_PREFIX=/opt/luthier/ -DCMAKE_PREFIX_PATH="/opt/luthier/"  \
      -DCMAKE_BUILD_TYPE=Release  \
      .. && ninja install && rm -rf $LLVM_SRC_DIR/llvm-project/amd/hipcc/build/
      ```
4. clone the Luthier project and build it:
   ```bash
   git clone https://github.com/matinraayai/luthier && cd luthier && mkdir build && \
   cmake -DCMAKE_PREFIX_PATH="/opt/luthier;/opt/rocm" -G Ninja \
   -DCMAKE_HIP_COMPILER=/opt/luthier/llvm/bin/clang++ \
   -DCMAKE_BUILD_TYPE=Release \
   -DLUTHIER_LLVM_SRC_DIR=${LLVM_SRC_DIR} \
   -DLLVM_DIR=/opt/luthier/llvm/lib/cmake/llvm/ -DCMAKE_HIP_FLAGS="-O3" .. && ninja build
   ```
   Notable flags:
   - `-DCMAKE_BUILD_TYPE` can be set to `Debug` or `RelWithDebInfo` to emit debug information in the compiled targets.
   - `-DCMAKE_PREFIX_PATH` should contain both `/opt/luthier` and `/opt/rocm`, so that it will include both 
   - `DCMAKE_HIP_COMPILER` must point to the `clang++` of Luthier, not the one shipped with ROCm.
   - `DLLVM_DIR` must point to `/opt/luthier/llvm/lib/cmake/llvm/`, the directory that contains CMake configuration
     files for the LLVM built for Luthier.
   - `-DLUTHIER_LLVM_SRC_DIR` must point to the source code of Luthier LLVM. 
   - `-DCMAKE_HIP_FLAGS` should be `"-O3"`, to force CMake to emit optimized device bitcode/binary. For now unoptimized
     tool device binaries are not supported in Luthier.
> [!TIP]
> Refer to the [Luthier Dev Dockerfile](../dockerfiles/luthier-dev/Dockerfile) and the
> [ROCm Dev Dockerfile](../dockerfiles/rocm-dev/Dockerfile) for more information on satisfying the build
> requirements. You can also build the development containers from scratch, or pull it from
> `containers.rc.northeastern.edu/luthier/luthier-dev-llvm-x-y-rocm-z`, where `x` is the LLVM version used, y is the
> build type of LLVM (shared or static), and z is the ROCm version.